<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>MiniSocial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .profile-avatar {
      width: 100px; height: 100px;
      border-radius: 50%; object-fit: cover;
    }
  </style>
  <link rel="icon" type="image/png" href="/image/logo-removebg-previews.png" />
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="dashboard.html">MiniSocial</a>
      <div class="d-flex">
        <a class="btn btn-outline-secondary btn-sm me-2" href="dashboard.html">Dashboard</a>
        <a class="btn btn-outline-danger btn-sm" href="auth.html">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <div class="text-center mb-4">
              <!-- Avatar mặc định, không cho thay đổi -->
              <img src="/image/logo.png" alt="avatar" class="profile-avatar mb-2">
              <h4 class="mb-0">Alice</h4>
              <small class="text-muted">alice@example.com</small>
              <p class="text-muted mt-2"><em>Ảnh đại diện mặc định (không thể thay đổi)</em></p>
            </div>

            <h5 class="mb-3">Cập nhật thông tin cá nhân</h5>
            <form id="profileForm" class="needs-validation" novalidate>
              <div class="mb-3">
                <label class="form-label">Tên hiển thị</label>
                <input type="text" class="form-control" name="displayName" value="Alice" required>
                <div class="invalid-feedback">Tên hiển thị không được để trống</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" value="alice@example.com" required>
                <div class="invalid-feedback">Email không hợp lệ</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Mật khẩu mới</label>
                <input type="password" class="form-control" name="password" placeholder="Để trống nếu không đổi">
              </div>
              <!-- Không có input upload avatar nữa -->
              <button class="btn btn-primary w-100" type="submit">Cập nhật</button>
            </form>

            <div id="profileAlert" class="alert alert-success mt-3 d-none">Cập nhật thành công (demo)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle + demo JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>

// helpers
function showAlert(text, type = "success", timeout = 2000) {
  const el = document.getElementById("profileAlert");
  el.className = `alert alert-${type} mt-3`;
  el.textContent = text;
  el.style.display = "block";
  if (timeout > 0) setTimeout(() => { el.className = "alert alert-success mt-3 d-none"; el.style.display = "none"; }, timeout);
}

function showFieldError(input, msg) {
  // mark invalid UI; bootstrap shows message if .invalid-feedback exists
  input.classList.add("is-invalid");
  const fb = input.nextElementSibling;
  if (fb && fb.classList && fb.classList.contains("invalid-feedback")) {
    fb.textContent = msg;
  }
}

// DOM refs
const profileForm = document.getElementById("profileForm");
const displayNameInput = profileForm.querySelector("input[name='displayName']");
const emailInput = profileForm.querySelector("input[name='email']");
const passwordInput = profileForm.querySelector("input[name='password']");
const submitBtn = profileForm.querySelector("button[type='submit']");
const avatarImg = document.querySelector(".profile-avatar");
const nameHeader = document.querySelector(".card-body h4"); // adjust if different
const emailSmall = document.querySelector(".card-body small.text-muted");

// load profile data and fill form
async function loadProfile() {
  try {
    const res = await fetch("/profile/me", { credentials: "same-origin" });
    if (!res.ok) {
      // maybe not logged in
      const txt = await res.text().catch(() => "");
      showAlert("Không thể tải profile: " + (txt || res.status), "danger", 4000);
      return;
    }
    const j = await res.json();
    if (j.error) {
      showAlert("Lỗi: " + j.error, "danger", 4000);
      return;
    }
    const user = j.user || {};
    displayNameInput.value = user.display_name || user.displayName || "";
    emailInput.value = user.email || "";
    // update header / avatar text if present
    if (nameHeader) nameHeader.textContent = user.display_name || user.username || "User";
    if (emailSmall) emailSmall.textContent = user.email || "";
    // avatar left as default (lab: can't change)
  } catch (err) {
    showAlert("Lỗi kết nối khi tải profile: " + err.message, "danger", 4000);
  }
}

// validate basic client-side
function validateForm() {
  // reset previous invalid classes
  [displayNameInput, emailInput].forEach(i => i.classList.remove("is-invalid"));

  if (!displayNameInput.value.trim()) {
    showFieldError(displayNameInput, "Tên hiển thị không được để trống");
    return false;
  }
  const email = emailInput.value.trim();
  if (!email) {
    showFieldError(emailInput, "Email không được để trống");
    return false;
  }
  // basic email regex
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!re.test(email)) {
    showFieldError(emailInput, "Email không hợp lệ");
    return false;
  }
  return true;
}

// submit update
async function submitProfile(e) {
  e.preventDefault();
  // form validation via bootstrap html5 + our checks
  if (!validateForm()) return;

  const payload = {
    displayName: displayNameInput.value.trim(),
    email: emailInput.value.trim(),
    password: passwordInput.value // may be empty
  };

  // disable UI
  submitBtn.disabled = true;
  const oldText = submitBtn.textContent;
  submitBtn.textContent = "Đang gửi...";

  try {
    const res = await fetch("/profile/update", {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify(payload)
    });

    const ct = res.headers.get("content-type") || "";
    let body;
    if (ct.includes("application/json")) {
      body = await res.json();
    } else {
      body = { raw: await res.text() };
    }

    if (res.ok && body.ok) {
      showAlert(body.message || "Cập nhật thành công", "success", 2000);
      // update header text if needed
      if (nameHeader) nameHeader.textContent = payload.displayName;
      if (emailSmall) emailSmall.textContent = payload.email;
      // clear password field
      passwordInput.value = "";
    } else {
      // error from server
      const msg = (body && (body.error || body.message)) || `Lỗi: ${res.status}`;
      showAlert(msg, "danger", 4000);
    }
  } catch (err) {
    showAlert("Lỗi kết nối: " + err.message, "danger", 4000);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = oldText;
  }
}

// bind events
profileForm.addEventListener("submit", submitProfile);

// run initial load
loadProfile();
</script>

</body>
</html>
